<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>축제 등록 | FesLite</title>
  <base href="/">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link th:href="@{/css/style.css}" rel="stylesheet">
  <script defer th:src="@{/js/app.js}"></script>
  <script defer th:src="@{/js/address.js}"></script>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=u4pl1guhug&submodules=geocoder"></script>

  <style>
    body {
      background: linear-gradient(135deg, #ffdee9 0%, #b5fffc 100%);
      font-family: 'Pretendard', sans-serif;
    }

    main {
      max-width: 720px;
      margin: 40px auto;
      padding: 20px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 30px 28px;
      background: #ffffffcc;
      border-radius: 16px;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    label {
      font-weight: 600;
      margin-bottom: 4px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
    }

    .address-group input[type="button"] {
      margin: 5px 0 10px 0;
      width: 100%;
      border-radius: 8px;
      border: none;
      padding: 10px;
      background: linear-gradient(90deg, #8e2de2 0%, #ff6a88 100%);
      color: #fff;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .address-group input[type="button"]:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button {
      align-self: center;
      padding: 12px 36px;
      border: none;
      border-radius: 30px;
      font-weight: bold;
      color: white;
      background: linear-gradient(90deg, #8e2de2 0%, #ff6a88 100%);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.25);
    }

    .header-img {
      display: block;
      width: 180px;
      margin: 40px auto 10px auto;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    #price_detail_box {
      margin-top: 10px;
      transition: all 0.25s ease;
    }

    /* ✅ 요금 구역 디자인 개선 */
    .price-box {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .price-option {
      position: relative;
    }

    .price-option input[type="radio"] {
      display: none;
    }

    .price-option label {
      display: inline-block;
      padding: 10px 22px;
      border-radius: 25px;
      cursor: pointer;
      background: #f3f3f3;
      font-weight: 600;
      color: #555;
      transition: all 0.3s ease;
      border: 1px solid #ddd;
      user-select: none;
    }

    .price-option input[type="radio"]:checked + label {
      background: linear-gradient(90deg, #8e2de2 0%, #ff6a88 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body>
  <div th:replace="~{common/header :: header}"></div>

  <main>
    <img th:src="@{/images/make-wish.png}" alt="축제 이미지" class="header-img" />
    <h2 style="text-align:center;margin-bottom:25px;">원하시는 축제를 등록해 보세요!</h2>

    <form id="projectPlanForm" th:action="@{/festival/regSubData}" method="post" th:object="${festival}" enctype="multipart/form-data">
      <label>축제 카테고리</label>
      <select name="festival_category_idx" th:field="*{festival_category_idx}" required>
        <option th:value="${cat.festival_category_idx}" th:each="cat : ${category}" th:text="${cat.festival_category_name}"></option>
      </select>

      <label>축제 제목</label>
      <input type="text" name="festival_name" th:field="*{festival_name}" placeholder="축제 제목을 입력하세요" required />

      <label>축제 상세내용</label>
      <textarea name="festival_info" th:field="*{festival_info}" rows="5" placeholder="축제 제안 내용을 입력하세요" required></textarea>

      <label>장소</label>
      <div class="address-group">
        <input type="hidden" id="sample6_postcode" placeholder="우편번호">
        <input type="hidden" id="sample6_detailAddress" placeholder="상세주소">
        <input type="hidden" id="sample6_extraAddress" placeholder="참고항목">
        <input type="button" onclick="sample6_execDaumPostcode()" value="주소 찾기">
        <input type="text" id="member_address" th:field="*{festival_address}" placeholder="주소를 입력하세요" required>
        <br>
        <label>관할지역을 지정해주세요</label>
        <select name="region_idx" th:field="*{region_idx}" required>
          <option th:value="${region.region_idx}" th:each="region : ${regions}" th:text="${region.region_name}"></option>
        </select>
      </div>

      <label>날짜 (시작일 - 종료일)</label>
      <div class="d-flex gap-2">
        <input type="date" th:field="*{festival_begin_date}" name="festival_begin_date" required />
        <input type="date" th:field="*{festival_end_date}" name="festival_end_date" required />
      </div>

      <label>요금</label>
      <div class="price-box">
        <div class="price-option">
          <input type="radio" name="festival_fee_radio" value="무료" id="price_free" checked>
          <label for="price_free">무료</label>
        </div>
        <div class="price-option">
          <input type="radio" name="festival_fee_radio" value="유료" id="price_paid">
          <label for="price_paid">유료</label>
        </div>
      </div>

      <!-- 유료 상세 -->
      <div id="price_detail_box" style="display:none;">
        <input type="text" id="fee_detail" placeholder="요금 상세내용 입력 (예: 성인 5,000원, 청소년 3,000원)" />
      </div>

      <!-- 서버로 전달될 최종 요금 -->
      <input type="hidden" name="festival_fee" id="festival_fee_hidden" th:field="*{festival_fee}" />

      <label>홈페이지</label>
      <input type="text" name="festival_link" th:field="*{festival_link}" placeholder="홈페이지 주소 입력" />

      <label>대표 이미지</label>
      <input type="file" name="upload_file" accept="image/*" />

      <input type="hidden" id="festival_lat" th:field="*{festival_lat}">
      <input type="hidden" id="festival_lot" th:field="*{festival_lot}">

      <div class="text-center mt-3">
        <button class="subButton" id="dbReg" type="submit" hidden>등록하기</button>
        <button id="changeLoca" type="button">등록하기</button>
      </div>
    </form>
  </main>

  <div th:replace="~{common/footer :: footer}"></div>

  <script>
    // 요금 토글: Thymeleaf가 id를 바꿔도 name/value 기준으로 안전하게 동작
    document.addEventListener('DOMContentLoaded', () => {
    const radios = document.querySelectorAll('input[name="festival_fee_radio"]');
    const detailBox = document.getElementById('price_detail_box');

    // 유료 선택 시 상세 입력창 표시
    function toggleFeeDetailBox() {
      const selected = document.querySelector('input[name="festival_fee_radio"]:checked').value;
      detailBox.style.display = selected === '유료' ? 'block' : 'none';
    }
    radios.forEach(r => r.addEventListener('change', toggleFeeDetailBox));
    toggleFeeDetailBox();

    // 등록 버튼 클릭
    document.getElementById('changeLoca').addEventListener('click', convertAddressAndSubmit);
  });

  // ✅ 요금 조합 함수
  function updateFestivalFee() {
    const selectedFee = document.querySelector('input[name="festival_fee_radio"]:checked').value;
    const feeDetail = document.getElementById('fee_detail').value.trim();
    const hiddenFee = document.getElementById('festival_fee_hidden');

    if (selectedFee === '유료' && feeDetail) {
      hiddenFee.value = `유료 (${feeDetail})`;
    } else if (selectedFee === '유료' && !feeDetail) {
      hiddenFee.value = '유료';
    } else {
      hiddenFee.value = '무료';
    }
  }

  // 주소 → 좌표 변환 후 제출
    document.getElementById('changeLoca').addEventListener('click', () => {
      updateFestivalFee();

      const addressInput = document.getElementById('member_address');
      if (!addressInput || !addressInput.value.trim()) {
        alert('주소를 입력하거나 주소 찾기를 먼저 진행해주세요.');
        return;
      }
      naver.maps.Service.geocode({ query: addressInput.value }, function(status, response) {
        if (status !== naver.maps.Service.Status.OK) {
          return alert('주소 변환 중 오류가 발생했습니다.');
        }
        const items = response.v2.addresses;
        if (!items || !items.length) {
          return alert('해당 주소를 찾을 수 없습니다.');
        }
        document.getElementById('festival_lot').value = items[0].x;
        document.getElementById('festival_lat').value = items[0].y;
        document.getElementById('dbReg').click();
      });
    });
  </script>
</body>
</html>
