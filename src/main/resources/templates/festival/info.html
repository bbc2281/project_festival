<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FesLite â€” ì¶•ì œ ìƒì„¸</title>
<base href="/">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link th:href="@{/css/style.css}" rel="stylesheet">
<script th:inline="javascript">
  const festival_idx = [[${festival.festival_idx}]];
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script defer th:src="@{/js/app.js}"></script>
<script defer th:src="@{/js/map.js}"></script>
<script defer th:src="@{/js/weather.js}"></script>
<script defer th:src="@{/js/locationInfo.js}"></script>
<script defer th:src="@{/js/chat.js}"></script>
<script th:src="@{/js/filtering.js}"></script>
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=u4pl1guhug"></script>

</head>

<body class="bg-gradient-festive">
  <!-- ìƒë‹¨ ë„¤ë¹„ë°” -->
  <div th:replace="~{common/header :: header}"></div>

  <main class="container py-5">
    <div class="row align-items-stretch g-4">
      <!-- ì™¼ìª½ íŒ¨ë„ -->
      <div class="col-lg-8 d-flex">
        <div class="gradient-card w-100">
          <div class="body">
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h3 class="fw-bold mb-0" th:text="${festival.festival_name}"></h3>
                <div class="text-muted mt-1">
                  <span th:text="${festival.festival_begin_date}"></span> ~
                  <span th:text="${festival.festival_end_date}"></span>
                  <span class="chip">ìš”ê¸ˆ: <span th:text="${festival.festival_fee}"></span></span>
                </div>
              </div>
            </div>

            <div style="border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
              <a th:href="${festival.festival_link}">
              <img th:src="${festival.festival_img_path != null ? festival.festival_img_path : '/images/default.png'}" 
                class="img-fluid rounded-4 shadow" 
                style="max-height: 600px; width: 100%; object-fit: contain;" 
                alt="ì¶•ì œ í¬ìŠ¤í„°">
              </a>
            </div>

            <div class="mb-2"><b>ì£¼ìµœ:</b> <span th:text="${festival.festival_host}"></span></div>
            <div class="mb-3"><b>ì£¼ì†Œ:</b> <span th:text="${festival.festival_address}"></span></div>

            <hr>
            <h5 class="fw-bold mb-2">ìƒì„¸ ì†Œê°œ</h5>
            <p th:text="${festival.festival_info}" style="white-space:pre-line;"></p>
            <span th:if="${festival.festival_info == 'ìƒì„¸ë‚´ìš©ì€ ë§í¬ë¥¼ ì°¸ì¡°í•´ ì£¼ì„¸ìš”'}"><a th:href="${festival.festival_link}" target="_blank"  style="text-decoration: none;"> - ìƒì„¸ì •ë³´(í´ë¦­)</a></span>

            <!-- ì§€ë„ / ê¸¸ì°¾ê¸° -->
            <div class="section">
              <h5 class="fw-bold mb-3">ì§€ë„</h5>
              <div class="gradient-card">
                <div class="body">
                  <div id ="map" class="map"></div>
                </div>
              </div>
            </div>

            <!-- ë‚ ì”¨ ì„¹ì…˜ -->
            <div class="section">
              <h5 class="fw-bold mb-3">ë‚ ì”¨</h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="gradient-card">
                    <div class="body text-center">
                      <div class="fw-bold" id="weather_time_today"></div>
                      <div class="text-muted" id="weather_sky_today"></div>
                      <div class="mt-2">
                        <span class="chip">ğŸŒ¡ï¸ìµœì €<span id="weather_temp_min_today"></span>â„ƒ</span>
                        <span class="chip">ğŸŒ¡ï¸ìµœê³ <span id="weather_temp_max_today"></span>â„ƒ</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="gradient-card">
                    <div class="body text-center">
                      <div class="fw-bold" id="weather_time_tomorrow"></div>
                      <div class="text-muted" id="weather_sky_tomorrow"></div>
                      <div class="mt-2">
                        <span class="chip">ğŸŒ¡ï¸ìµœì €<span id="weather_temp_min_tomorrow"></span>â„ƒ</span>
                        <span class="chip">ğŸŒ¡ï¸ìµœê³ <span id="weather_temp_max_tomorrow"></span>â„ƒ</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="gradient-card">
                    <div class="body text-center">
                      <div class="fw-bold" id="weather_time_dat"></div>
                      <div class="text-muted" id="weather_sky_dat"></div>
                      <div class="mt-2">
                        <span class="chip">ğŸŒ¡ï¸ìµœì €<span id="weather_temp_min_dat"></span>â„ƒ</span>
                        <span class="chip">ğŸŒ¡ï¸ìµœê³ <span id="weather_temp_max_dat"></span>â„ƒ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì£¼ë³€ ì¦ê¸¸ê±°ë¦¬ -->
            <div class="section">
              <h5 class="fw-bold mb-3">ì£¼ë³€ ì¦ê¸¸ê±°ë¦¬</h5>
              <div class="row g-3">
                <div class="col-md-12">
                  <div class="gradient-card">
                    <div class="body text-center" id="locationInfo_list">

                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
      <div class="col-lg-4 d-flex flex-column justify-content-start" style="gap: 0.25rem;">
        <!-- ë¦¬ë·° -->
        <!-- <div class="gradient-card" style="max-height: 500px; height: 500px;">
          <div class="body d-flex flex-column h-100">
            <h5 class="fw-bold mb-3">ë¦¬ë·°</h5>
            <div id="reviewList" class="vstack gap-2 mb-3 flex-grow-1 overflow-auto">
              <div class="border rounded p-2 bg-light"><b>ìµëª…</b> â€” ì •ë§ ì¬ë°Œì—ˆì–´ìš”!</div>
            </div>
            <div class="input-group mt-auto">
              <input type="text" class="form-control" id="reviewText" placeholder="í•œì¤„ ë¦¬ë·° ì‘ì„±" />
              <button class="btn-gradient" id="btnAddReview">ë“±ë¡</button>
            </div>
          </div>
        </div> -->

        <!-- ì±„íŒ… -->
        <div class="sticky-wrapper">
        <div class="gradient-card" style="max-height: 500px; height: 500px;">
          <div class="body d-flex flex-column h-100">
            <h5 class="fw-bold mb-3">ì±„íŒ…ë°©</h5>
            <div class="chat-box flex-grow-1 overflow-auto" id="chatBox">
            </div>
            <div class="input-group mt-2">
              <input type="text" id="chatInput" class="form-control" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
              <button class="btn-gradient" id="btnSendChat">ë³´ë‚´ê¸°</button>
            </div>
          </div>
        </div>
        </div>
      </div>
</main>

  <!-- í•˜ë‹¨ í‘¸í„° -->
  <div th:replace="~{common/footer :: footer}"></div>
<!-- 
  <script>
    // ë¦¬ë·° ì¶”ê°€
    document.getElementById("btnAddReview").addEventListener("click", () => {
      const text = document.getElementById("reviewText").value.trim();
      if (!text) return;
      const div = document.createElement("div");
      div.className = "border rounded p-2 bg-light";
      div.innerHTML = `<b>ìµëª…</b> â€” ${text}`;
      document.getElementById("reviewList").prepend(div);
      document.getElementById("reviewText").value = "";
    });
  </script> -->
  <!-- ì±„íŒ… -->
  <script th:inline="javascript">
        const roomId = `[[${chatRoom.chat_room_idx}]]`;
        function isValid(value) {
          return value != null && value !== "" && value !== "null";
        }
        //ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ì•„ì´ë””, ì•„ì´ë”” ì—†ìœ¼ë©´ ì´ë©”ì¼ ì¶œë ¥
        let loginMember = isValid(`[[${loginMember.member_nickname}]]`) 
                                  ? `[[${loginMember.member_nickname}]]`
                                  : isValid(`[[${loginMember.member_id}]]`)
                                  ? `[[${loginMember.member_id}]]`
                                  : `[[${loginMember.member_email}]]`;
        loginMember = loginMember.replace(/^"(.*)"$/, '$1');
        const loginMemberIdx = `[[${loginMember.member_idx}]]`//í˜„ì¬ ì ‘ì†í•œ íšŒì›ì˜ ê¸°ë³¸í‚¤
        const socket = new SockJS("/ws");//ì›¹ì†Œì¼“ ì—°ê²° ê°ì²´
        let stompClient = Stomp.over(socket);//STOMP í”„ë¡œí† ì½œ ì´ìš©
        
        const chatBox = document.getElementById("chatBox");
        const chatInput = document.getElementById("chatInput");
        //ì›¹ì†Œì¼“ ì—°ê²°, êµ¬ë… ì„¤ì •(ìˆ˜ì‹ )
        stompClient.connect({}, function(response){
          stompClient.subscribe(`/topic/chat/${roomId}`, function(message){
              let chatMessage = JSON.parse(message.body);
              //ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€(JSON)ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¡œ ë³€í™˜
              showMessage(chatMessage);
          });
          let welcome = {
            chat_type : "SYSTEM",
            chat_room : parseInt(roomId),
            chat_sender : parseInt(loginMemberIdx),
            chat_message : `'${loginMember}'ë‹˜ì´<br>ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤`
          };
          stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(welcome));
        }, function(error){
          console.log(`ì›¹ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨`);  
        });
  </script>
</body>
</html>
