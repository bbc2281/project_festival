<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FesLite â€” ì¶•ì œ ìƒì„¸</title>
<base href="/">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link th:href="@{/css/style.css}" rel="stylesheet">
<script th:inline="javascript">
  const festival_idx = [[${festival.festival_idx}]];
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script defer th:src="@{/js/app.js}"></script>
<script defer th:src="@{/js/map.js}"></script>
<script defer th:src="@{/js/weather.js}"></script>
<script defer th:src="@{/js/locationInfo.js}"></script>
<script defer th:src="@{/js/chat.js}"></script>
<script defer th:src="@{/js/favorite.js}"></script>
<script th:src="@{/js/filtering.js}"></script>
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=u4pl1guhug"></script>
<style>
    /* ğŸ–¼ï¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .gallery-thumb {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .gallery-thumb:hover {
      transform: scale(1.05);
    }

    .gallery-modal img {
      width: 100%;
      max-width: 800px;
      height: auto;
      object-fit: contain;
      border-radius: 12px;
    }
  </style>
</head>

<body class="bg-gradient-festive">
  <div id="sessionInfo"
     th:data-login-id="${session.loginMember != null ? session.loginMember.member_idx : 0}">
  </div>
  <!-- ìƒë‹¨ ë„¤ë¹„ë°” -->
  <div th:replace="~{common/header :: header}"></div>

  <main class="container py-5">
    <div class="row align-items-stretch g-4">
      <!-- ì™¼ìª½ íŒ¨ë„ -->
      <div class="col-lg-8 d-flex">
        <div class="gradient-card w-100">
          <div class="body">
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h3 class="fw-bold mb-0" th:text="${festival.festival_name}"></h3>
                <div class="text-muted mt-1">
                  <span th:text="${festival.festival_begin_date}"></span> ~
                  <span th:text="${festival.festival_end_date}"></span>
                  <span class="chip">ìš”ê¸ˆ: <span th:text="${festival.festival_fee}"></span></span>
                  <button 
                    class="btn btn-sm border-0 bg-transparent" 
                    id="btnFavorite"
                    th:data-festival-idx="${festival.festival_idx}"
                    data-funding-idx="0"
                    th:data-member-id="${session.loginMember != null ? session.loginMember.member_idx : 0}"
                    th:data-company-id="${session.companyMember != null ? session.companyMember.company_idx : 0}"
                    >
                  <i class="bi" 
                    th:classappend="${isFavorite} ? 'bi-heart-fill text-danger fs-4' : 'bi-heart fs-4'"></i>
                </button>
                </div>
              </div>
            </div>

            <div style="border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
              <a th:href="${festival.festival_link}">
              <img th:src="${festival.festival_img_path != null ? festival.festival_img_path : '/images/default.png'}" 
                class="img-fluid rounded-4 shadow" 
                style="max-height: 600px; width: 100%; object-fit: contain;" 
                alt="ì¶•ì œ í¬ìŠ¤í„°">
              </a>
            </div>

            <div class="mb-2"><b>ì£¼ìµœ:</b> <span th:text="${festival.festival_host}"></span></div>
            <div class="mb-3"><b>ì£¼ì†Œ:</b> <span th:text="${festival.festival_address}"></span></div>

            <hr>
            <h5 class="fw-bold mb-2">ìƒì„¸ ì†Œê°œ</h5>
            <p th:text="${festival.festival_info}" style="white-space:pre-line;"></p>
            <span th:if="${festival.festival_info == 'ìƒì„¸ë‚´ìš©ì€ ë§í¬ë¥¼ ì°¸ì¡°í•´ ì£¼ì„¸ìš”'}"><a th:href="${festival.festival_link}" target="_blank"  style="text-decoration: none;"> - ìƒì„¸ì •ë³´(í´ë¦­)</a></span>

            <!-- ì§€ë„ / ê¸¸ì°¾ê¸° -->
            <div class="section">
              <h5 class="fw-bold mb-3">ì§€ë„</h5>
              <div class="gradient-card">
                <div class="body">
                  <div id ="map" class="map"></div>
                </div>
              </div>
            </div>

            <!-- ë‚ ì”¨ ì„¹ì…˜ -->
            <div class="section">
              <h5 class="fw-bold mb-3">ë‚ ì”¨</h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="gradient-card">
                    <div class="body text-center">
                      <div class="fw-bold" id="weather_time_today"></div>
                      <div class="text-muted" id="weather_sky_today"></div>
                      <div class="mt-2">
                        <span class="chip">ğŸŒ¡ï¸ìµœì €<span id="weather_temp_min_today"></span>â„ƒ</span> <br>
                        <span class="chip">ğŸŒ¡ï¸ìµœê³ <span id="weather_temp_max_today"></span>â„ƒ</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="gradient-card">
                    <div class="body text-center">
                      <div class="fw-bold" id="weather_time_tomorrow"></div>
                      <div class="text-muted" id="weather_sky_tomorrow"></div>
                      <div class="mt-2">
                        <span class="chip">ğŸŒ¡ï¸ìµœì €<span id="weather_temp_min_tomorrow"></span>â„ƒ</span> <br>
                        <span class="chip">ğŸŒ¡ï¸ìµœê³ <span id="weather_temp_max_tomorrow"></span>â„ƒ</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="gradient-card">
                    <div class="body text-center">
                      <div class="fw-bold" id="weather_time_dat"></div>
                      <div class="text-muted" id="weather_sky_dat"></div>
                      <div class="mt-2">
                        <span class="chip">ğŸŒ¡ï¸ìµœì €<span id="weather_temp_min_dat"></span>â„ƒ</span> <br>
                        <span class="chip">ğŸŒ¡ï¸ìµœê³ <span id="weather_temp_max_dat"></span>â„ƒ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì£¼ë³€ ì¦ê¸¸ê±°ë¦¬ -->
            <div class="section">
              <h5 class="fw-bold mb-3">ì£¼ë³€ ì¦ê¸¸ê±°ë¦¬</h5>
              <div class="row g-3">
                <div class="col-md-12">
                  <div class="gradient-card">
                    <div class="body text-center" id="locationInfo_list">

                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
      <div class="col-lg-4 d-flex flex-column justify-content-start" style="gap: 0.25rem;">
       

        <!-- ì±„íŒ… -->
        <div class="sticky-wrapper">
        <div class="gradient-card" style="max-height: 500px; height: 500px;">
          <div class="body d-flex flex-column h-100">
            <h5 class="fw-bold mb-3">ì±„íŒ…ë°©</h5>
            <div class="chat-box flex-grow-1 overflow-auto" id="chatBox">
            </div>
            <div class="input-group mt-2">
              <input type="text" id="chatInput" class="form-control" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
              <button class="btn-gradient" id="btnSendChat">ë³´ë‚´ê¸°</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸŸ¢ ë¦¬ë·°: ë©”ì¸ ë§¨ ì•„ë˜ë¡œ ì´ë™ -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="gradient-card" style="height: 650px;">
          <div class="body d-flex flex-column h-100">
                <h5 class="fw-bold mb-3">
                ë¦¬ë·°
                <span id="reviewCount" class="text-muted ms-2" style="font-size: 0.9rem;"></span>
              </h5>

              <!-- ğŸ–¼ í•œ ì¤„ ê³ ì • ë¦¬ë·° ê°¤ëŸ¬ë¦¬ -->
              <div id="reviewGalleryFixed" class="mb-3 shadow-sm">

                <!-- ì™¼ìª½ ì´ë¯¸ì§€ ì˜ì—­ -->
                <div class="left-strip">
                  <div th:each="review : ${reviews}" th:if="${review.review_img_path != null}" class="thumb-box">
                    <img class="gallery-thumb" th:src="@{${review.review_img_path}}"
                      th:attr="data-src=@{${review.review_img_path}}">
                  </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ â€œë”ë³´ê¸°â€ -->
                <div class="more-box" id="openGalleryModal">
                  <div class="count" th:text="${#lists.size(reviews.?[review_img_path != null])}"></div>
                  <div class="more-text">ë”ë³´ê¸°</div>
                </div>

              </div>



              <hr class="my-3">

              <!-- ë¦¬ë·° ëª©ë¡ -->
              <div id="reviewList" class="flex-grow-1 overflow-auto">
                <div th:each="review : ${reviews}" class="border rounded p-2 bg-light mb-2 review-box">
                  <b th:text="${review.member_nickname}"></b> â€”
                  <span class="review-content" th:text="${review.review_content}"></span><br>

                  <img th:if="${review.review_img_path != null}" th:src="@{${review.review_img_path}}"
                    class="img-fluid mt-2 review-image" style="max-height:200px;">

                  <div class="mt-2 d-flex gap-2">
                    
                    <button class="review-btn modify btnModifyReview" th:data-review-idx="${review.review_idx}"
                      th:data-review-content="${review.review_content}" th:data-writer-id="${review.member_idx}">
                      âœ ìˆ˜ì •
                    </button>

                    <button class="review-btn delete btnDeleteReview" th:data-review-idx="${review.review_idx}" th:data-writer-id="${review.member_idx}">
                      ğŸ—‘ ì‚­ì œ
                    </button>
                    

                    <button class="review-btn reply commentBtn" th:data-review-idx="${review.review_idx}" th:data-writer-id="${review.member_idx}" >
                      ğŸ’¬ ë‹µê¸€
                    </button>
                  </div>
                </div>
              </div>

              <!-- ë¦¬ë·° ì‘ì„± -->
              <div class="mt-3" sec:authorize="hasAuthority('ROLE_USER')">
                <input type="file" id="reviewImage" class="form-control mb-2" accept="image/*">
                <input type="text" class="form-control" id="reviewText" placeholder="í•œì¤„ ë¦¬ë·° ë˜ëŠ” ëŒ“ê¸€ ì…ë ¥">
                <button class="btn-gradient mt-2 w-100" id="btnAddReview">ë“±ë¡</button>
              </div>
          </div>
        </div>
      </div>
    </div>
  </main>



  <!-- í•˜ë‹¨ í‘¸í„° -->
  <div th:replace="~{common/footer :: footer}"></div>

  <!-- ì±„íŒ… -->
  <script th:inline="javascript">
        const festivalBeginDateStr = /*[[${festival.festival_begin_date}]]*/ '2025-11-01';
        const festivalEndDateStr = /*[[${festival.festival_end_date}]]*/ '2025-11-30';
        const roomId = `[[${chatRoom.chat_room_idx}]]`;
        const isLogin = [[${loggedIn}]];
        const socket = new SockJS("/ws");//ì›¹ì†Œì¼“ ì—°ê²° ê°ì²´
        let stompClient = Stomp.over(socket);//STOMP í”„ë¡œí† ì½œ ì´ìš©
        const chatBox = document.getElementById("chatBox");
        const chatInput = document.getElementById("chatInput");
        const btnSendChat = document.getElementById("btnSendChat");

        function isValid(value) {
          return value != null && value !== "" && value !== "null";
        }

        //ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ì•„ì´ë””, ì•„ì´ë”” ì—†ìœ¼ë©´ ì´ë©”ì¼ ì¶œë ¥
        let loginMember;
        let loginMemberIdx;
        
        if(isLogin){
          loginMember =  (isValid(`[[${loginMember.member_nickname}]]`) 
                                    ? `[[${loginMember.member_nickname}]]`
                                    : `[[${loginMember.member_email}]]`);
          loginMember = loginMember.replace(/^"(.*)"$/, '$1');
          loginMemberIdx =`[[${loginMember.member_idx}]]`;//í˜„ì¬ ì ‘ì†í•œ íšŒì›ì˜ ê¸°ë³¸í‚¤
        }else{
          loginMember = null;
          loginMemberIdx = null;
        }

        //ì›¹ì†Œì¼“ ì—°ê²°, êµ¬ë… ì„¤ì •(ìˆ˜ì‹ )
        stompClient.connect({}, function(response){
          if (!isChatAllowed()) {
            chatInput.disabled = true;
            btnSendChat.disabled = true;
            chatBox.innerHTML = `<span class="bubble system">ì±„íŒ…ì€ ì¶•ì œ ì‹œì‘ 1ë‹¬ ì „ë¶€í„° ì¢…ë£Œ 1ë‹¬ í›„ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>`;
            chatInput.placeholder = ``;
            return;
          }
          stompClient.subscribe(`/topic/chat/${roomId}`, function(message){
              let chatMessage = JSON.parse(message.body);
              //ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€(JSON)ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¡œ ë³€í™˜
              showMessage(chatMessage);
          });
          
          if(!isLogin){
            chatInput.disabled = true;
            btnSendChat.disabled = true;
            chatInput.placeholder = "ë¡œê·¸ì¸ í›„ ì±„íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
          }else{
            let welcome = {
            chat_type : "SYSTEM",
            chat_room : parseInt(roomId),
            chat_sender : parseInt(loginMemberIdx),
            chat_message : `'${loginMember}'ë‹˜ì´<br>ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤`
            };
            stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(welcome));
          }
        }, function(error){
          console.log(`ì›¹ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨`);  
        });

    function isChatAllowed() {
    const today = new Date();
    const festivalBegin = new Date(festivalBeginDateStr);
    const festivalEnd = new Date(festivalEndDateStr);

    // í•œ ë‹¬ ì „, í•œ ë‹¬ í›„ ë‚ ì§œ ê³„ì‚°
    const monthBeforeBegin = new Date(festivalBegin);
    monthBeforeBegin.setMonth(monthBeforeBegin.getMonth() - 1);

    const monthAfterEnd = new Date(festivalEnd);
    monthAfterEnd.setMonth(monthAfterEnd.getMonth() + 1);

    // ì˜¤ëŠ˜ ë‚ ì§œê°€ (ì¶•ì œ ì‹œì‘ 1ë‹¬ ì „) ~ (ì¶•ì œ ì¢…ë£Œ 1ë‹¬ í›„) ë²”ìœ„ ë‚´ì¸ê°€?
    return (today >= monthBeforeBegin) && (today <= monthAfterEnd);
}
  </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ -->


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = new bootstrap.Modal(document.getElementById("galleryModal"));
      const modalImg = document.getElementById("galleryModalImg");

      const thumbs = Array.from(document.querySelectorAll(".gallery-thumb"));
      let index = 0;

      function show(indexNum) {
        modalImg.src = thumbs[indexNum].getAttribute("data-src");
        index = indexNum;
        modal.show();
      }

      thumbs.forEach((img, i) => {
        img.addEventListener("click", () => show(i));
      });

      
      // â† â†’ í‚¤ë³´ë“œë¡œ ì´ì „/ë‹¤ìŒ ì‚¬ì§„ ë„˜ê¸°ê¸°
      document.addEventListener("keydown", (e) => {
        if (!document.getElementById("galleryModal").classList.contains("show")) return;
        if (e.key === "ArrowRight") {
          index = (index + 1) % thumbs.length;
          show(index);
        }
        if (e.key === "ArrowLeft") {
          index = (index - 1 + thumbs.length) % thumbs.length;
          show(index);
        }
      });
    });
  </script>

  <!-- ğŸ“Œ ì „ì²´ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="galleryAllModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content p-3">
      <button type="button" class="btn-close ms-auto mb-2" data-bs-dismiss="modal"></button>
       <!-- ì´ ê°œìˆ˜ í‘œì‹œ -->
        <h5 id="galleryAllCount" class="fw-bold mb-3 text-center"></h5>
      <div class="row g-3" id="galleryAllContainer"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const allModal = new bootstrap.Modal(document.getElementById("galleryAllModal"));
  const container = document.getElementById("galleryAllContainer");
  const countBox = document.getElementById("galleryAllCount");

  document.getElementById("openGalleryModal")?.addEventListener("click", (e) => {

    e.stopPropagation(); // ë‹¨ì¼ëª¨ë‹¬ ì´ë²¤íŠ¸ ë§‰ê¸°

    const allThumbs = Array.from(document.querySelectorAll(".gallery-thumb"));

    // ğŸ”¥ ì´ ì´ë¯¸ì§€ ê°œìˆ˜ í‘œì‹œ
    countBox.textContent = `ğŸ“· ì „ì²´ ì´ë¯¸ì§€ (ì´ ${allThumbs.length}ê°œ)`;

    container.innerHTML = ""; // ê¸°ì¡´ ì´ë¯¸ì§€ ë¹„ìš°ê¸°

    allThumbs.forEach(t => {
      const col = document.createElement("div");
      col.className = "col-4";

      const img = document.createElement("img");
      img.src = t.dataset.src;
      img.style.cursor = "pointer";

      // ì „ì²´ ë³´ê¸° ìƒíƒœì—ì„œë„ ê°œë³„ í´ë¦­ ì‹œ í° ëª¨ë‹¬ ë„ìš°ê¸°
      img.addEventListener("click", () => {
        document.getElementById("galleryModalImg").src = t.dataset.src;
        const big = new bootstrap.Modal(document.getElementById("galleryModal"));
        big.show();
      });

      col.appendChild(img);
      container.appendChild(col);
    });

    allModal.show();
  });
});
</script>
<script>
    const loginId = [[${session.loginMember != null ? session.loginMember.member_idx : 0}]];
    console.log(loginId);
    document.querySelectorAll(".btnModifyReview, .btnDeleteReview, .commentBtn").forEach(btn => {
    if (btn.dataset.writerId != loginId) {
        btn.style.display = "none";
        console.log(btn.dataset.writerId);
    }
    }); 
</script>
<script th:src="@{/js/review.js}"></script>
<script th:src="@{/js/comment.js}"></script>
</body>
</html>